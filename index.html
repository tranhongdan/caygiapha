<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cây Gia Phả Đại Tộc</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel để biên dịch JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Style tùy chỉnh cho in ấn -->
    <style>
        @media print {
            body * {
                visibility: hidden;
            }
            #root, #root * {
                visibility: visible;
            }
            .print\:hidden {
                display: none !important;
            }
            body {
                background: white;
                -webkit-print-color-adjust: exact;
            }
            .overflow-hidden {
                overflow: visible !important;
            }
            /* Ẩn các nút hành động khi in */
            .group:hover .opacity-0 {
                opacity: 0 !important;
            }
        }
        
        .animate-in {
            animation: fadeIn 0.2s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Custom scrollbar cho modal nếu cần */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1; 
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- ICONS ---
        const Icons = {
            Plus: ({ size = 24 }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            ),
            Trash2: ({ size = 24 }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
            ),
            Edit2: ({ size = 24 }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
            ),
            ZoomIn: ({ size = 24 }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
            ),
            ZoomOut: ({ size = 24 }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
            ),
            Download: ({ size = 24 }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            ),
            Move: ({ size = 24 }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="5 9 2 12 5 15"></polyline><polyline points="9 5 12 2 15 5"></polyline><polyline points="15 19 12 22 9 19"></polyline><polyline points="19 15 22 12 19 9"></polyline><line x1="2" y1="12" x2="22" y2="12"></line><line x1="12" y1="2" x2="12" y2="22"></line></svg>
            ),
            RotateCw: ({ size = 24 }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
            )
        };

        // --- DATA STRUCTURE & INITIAL DATA ---
        const duLieuKhoiTao = {
            id: 'goc',
            hoTen: 'Ông Tổ',
            ngaySinh: '',
            voChong: '',
            ghiChu: 'Người sáng lập dòng họ',
            kieuBoCuc: 'ngang', // 'ngang' = Cây, 'doc' = Danh sách
            conCai: []
        };

        // --- HELPER FUNCTIONS ---
        const taoId = () => Math.random().toString(36).substr(2, 9);

        // Update node by ID
        const capNhatNut = (nutHienTai, idCanTim, duLieuMoi) => {
            if (nutHienTai.id === idCanTim) {
                return { ...nutHienTai, ...duLieuMoi };
            }
            if (nutHienTai.conCai && nutHienTai.conCai.length > 0) {
                return {
                    ...nutHienTai,
                    conCai: nutHienTai.conCai.map(con => capNhatNut(con, idCanTim, duLieuMoi))
                };
            }
            return nutHienTai;
        };

        // Add child
        const themConVaoNut = (nutHienTai, idCha, conMoi) => {
            if (nutHienTai.id === idCha) {
                return {
                    ...nutHienTai,
                    conCai: [...(nutHienTai.conCai || []), conMoi]
                };
            }
            if (nutHienTai.conCai && nutHienTai.conCai.length > 0) {
                return {
                    ...nutHienTai,
                    conCai: nutHienTai.conCai.map(con => themConVaoNut(con, idCha, conMoi))
                };
            }
            return nutHienTai;
        };

        // Delete node
        const xoaNutKhoiCay = (nutHienTai, idCanXoa) => {
            if (!nutHienTai.conCai) return nutHienTai;
            const conCaiMoi = nutHienTai.conCai
                .filter(con => con.id !== idCanXoa)
                .map(con => xoaNutKhoiCay(con, idCanXoa));
            return { ...nutHienTai, conCai: conCaiMoi };
        };

        // Toggle Layout (Ngang/Doc)
        const doiKieuBoCuc = (nutHienTai, id) => {
            if (nutHienTai.id === id) {
                const kieuMoi = (nutHienTai.kieuBoCuc === 'doc') ? 'ngang' : 'doc';
                return { ...nutHienTai, kieuBoCuc: kieuMoi };
            }
            if (nutHienTai.conCai) {
                return {
                    ...nutHienTai,
                    conCai: nutHienTai.conCai.map(con => doiKieuBoCuc(con, id))
                };
            }
            return nutHienTai;
        };

        // --- COMPONENT: NUT CAY ---
        const NutCay = ({ nut, onThem, onSua, onXoa, onDoiBoCuc, capDo }) => {
            const coCon = nut.conCai && nut.conCai.length > 0;
            const kieuBoCuc = nut.kieuBoCuc || 'ngang';
            const isNgang = kieuBoCuc === 'ngang';

            return (
                <div className="flex flex-col items-center">
                    {/* Node Display */}
                    <div className="relative flex flex-col items-center z-10">
                        {/* Card Info */}
                        <div className="group relative">
                            {/* Khung bao ngoai (Border, Shadow, Toolbar Position) */}
                            {/* UPDATED: rounded-xl -> rounded-md for tighter look */}
                            <div className={`
                                relative bg-white border-4 rounded-md shadow-md transition-all duration-200 
                                hover:shadow-xl hover:scale-105 hover:border-blue-600 w-max
                                ${capDo === 0 ? 'border-red-600 border-8' : 'border-gray-500'}
                            `}>
                                {/* Actions Toolbar */}
                                <div className={`
                                    absolute left-1/2 transform -translate-x-1/2 flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white px-2 rounded-full shadow-sm border print:hidden z-20
                                    ${!isNgang ? '-right-3 top-1/2 -translate-y-1/2 left-auto translate-x-full flex-col space-x-0 space-y-1' : '-top-3 top-auto flex-row'}
                                `}>
                                    <button onClick={() => onThem(nut.id)} className="p-1 text-green-600 hover:bg-green-50 rounded-full" title="Thêm con">
                                        <Icons.Plus size={16} />
                                    </button>
                                    <button onClick={() => onSua(nut)} className="p-1 text-blue-600 hover:bg-blue-50 rounded-full" title="Sửa thông tin">
                                        <Icons.Edit2 size={16} />
                                    </button>
                                    <button 
                                        onClick={() => onDoiBoCuc(nut.id)}
                                        className={`p-1 rounded-full transition-colors ${!isNgang ? 'text-purple-600 bg-purple-50 font-bold' : 'text-gray-400 hover:text-purple-600'}`}
                                        title={`Đổi hướng: ${isNgang ? 'Ngang' : 'Dọc'}`}
                                    >
                                        <Icons.RotateCw size={16} />
                                    </button>
                                    {capDo !== 0 && (
                                        <button onClick={() => onXoa(nut.id)} className="p-1 text-red-600 hover:bg-red-50 rounded-full" title="Xóa nhánh">
                                            <Icons.Trash2 size={16} />
                                        </button>
                                    )}
                                </div>

                                {/* NOI DUNG THONG TIN */}
                                {/* UPDATED: p-3 -> p-1, gap-1 -> gap-0, remove min-w/h to hug text */}
                                <div className={`
                                    p-1 flex flex-col gap-0 text-center items-center justify-center
                                    ${!isNgang ? '[writing-mode:vertical-rl] rotate-180 py-2' : ''}
                                `}>
                                    <div className="font-bold text-gray-800 text-sm uppercase whitespace-nowrap">{nut.hoTen}</div>
                                    {nut.ngaySinh && <div className="text-xs text-gray-600 whitespace-nowrap">{nut.ngaySinh}</div>}
                                    {nut.voChong && <div className="text-xs text-purple-700 whitespace-nowrap">{nut.voChong}</div>}
                                    {nut.ghiChu && <div className="text-[10px] text-gray-400 italic whitespace-nowrap">{nut.ghiChu}</div>}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Connector from Parent to Children Group */}
                    {coCon && (
                        <div className="w-1 h-8 bg-gray-500"></div>
                    )}

                    {/* Children Rendering Logic */}
                    {coCon && (
                        <>
                            {isNgang ? (
                                // --- LAYOUT NGANG (HORIZONTAL TREE) ---
                                <div className="flex justify-center">
                                    {nut.conCai.map((con, index) => (
                                        <div key={con.id} className="relative px-2 pt-8 flex flex-col items-center">
                                            {/* Top Horizontal Connectors */}
                                            {index > 0 && <div className="absolute top-0 right-1/2 w-1/2 h-1 bg-gray-500"></div>}
                                            {index < nut.conCai.length - 1 && <div className="absolute top-0 left-1/2 w-1/2 h-1 bg-gray-500"></div>}
                                            
                                            {/* Connector Down */}
                                            <div className="absolute top-0 left-1/2 -translate-x-1/2 w-1 h-8 bg-gray-500"></div>
                                            
                                            <NutCay nut={con} onThem={onThem} onSua={onSua} onXoa={onXoa} onDoiBoCuc={onDoiBoCuc} capDo={capDo + 1} />
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                // --- LAYOUT DOC (VERTICAL LIST) ---
                                <div className="flex flex-col items-center relative pt-2">
                                    <div className="w-8 h-1 bg-gray-500 mb-2"></div>
                                    
                                    {nut.conCai.map((con, index) => (
                                        <div key={con.id} className="relative flex flex-col items-center pb-4">
                                            {index < nut.conCai.length - 1 && (
                                                <div className="absolute top-0 bottom-0 left-1/2 w-1 bg-gray-400 -z-10"></div>
                                            )}
                                            <NutCay nut={con} onThem={onThem} onSua={onSua} onXoa={onXoa} onDoiBoCuc={onDoiBoCuc} capDo={capDo + 1} />
                                        </div>
                                    ))}
                                </div>
                            )}
                        </>
                    )}
                </div>
            );
        };

        // --- COMPONENT: MODAL ---
        const ModalNhapLieu = ({ dangMo, duLieu, onClose, onSave, cheDo }) => {
            if (!dangMo) return null;
            const handleSubmit = (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                onSave({
                    hoTen: formData.get('hoTen'),
                    ngaySinh: formData.get('ngaySinh'),
                    voChong: formData.get('voChong'),
                    ghiChu: formData.get('ghiChu'),
                });
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-md p-6 animate-in">
                        <h2 className="text-xl font-bold mb-4 text-gray-800">{cheDo === 'them' ? 'Thêm Thành Viên' : 'Sửa Thông Tin'}</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div><label className="block text-sm font-medium text-gray-700">Họ và Tên *</label><input name="hoTen" defaultValue={duLieu?.hoTen} required className="w-full px-3 py-2 border rounded-md" /></div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="block text-sm font-medium text-gray-700">Năm Sinh</label><input name="ngaySinh" defaultValue={duLieu?.ngaySinh} className="w-full px-3 py-2 border rounded-md" /></div>
                                <div><label className="block text-sm font-medium text-gray-700">Vợ/Chồng</label><input name="voChong" defaultValue={duLieu?.voChong} className="w-full px-3 py-2 border rounded-md" /></div>
                            </div>
                            <div><label className="block text-sm font-medium text-gray-700">Ghi Chú</label><textarea name="ghiChu" defaultValue={duLieu?.ghiChu} className="w-full px-3 py-2 border rounded-md" rows="3"></textarea></div>
                            <div className="flex justify-end space-x-3 pt-4 border-t">
                                <button type="button" onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-md">Hủy</button>
                                <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Lưu</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const UngDungGiaPha = () => {
            const [cayGiaPha, setCayGiaPha] = useState(duLieuKhoiTao);
            const [modal, setModal] = useState({ mo: false, cheDo: '', idDuocChon: null, duLieuCu: null });
            const [tyLeZoom, setTyLeZoom] = useState(1);
            const [viTri, setViTri] = useState({ x: 0, y: 0 });
            const [dangKeo, setDangKeo] = useState(false);
            const vungVeRef = useRef(null);

            const moModalThem = (idCha) => setModal({ mo: true, cheDo: 'them', idDuocChon: idCha, duLieuCu: {} });
            const moModalSua = (nut) => setModal({ mo: true, cheDo: 'sua', idDuocChon: nut.id, duLieuCu: nut });

            const xuLyLuuModal = (duLieuForm) => {
                if (modal.cheDo === 'them') {
                    const conMoi = { id: taoId(), ...duLieuForm, conCai: [], kieuBoCuc: 'ngang' };
                    setCayGiaPha(prev => themConVaoNut(prev, modal.idDuocChon, conMoi));
                } else {
                    setCayGiaPha(prev => capNhatNut(prev, modal.idDuocChon, duLieuForm));
                }
                setModal({ ...modal, mo: false });
            };

            const xuLyDoiBoCuc = (id) => {
                setCayGiaPha(prev => doiKieuBoCuc(prev, id));
            };

            const xuLyXoa = (id) => {
                if (confirm('Xóa thành viên này sẽ xóa cả nhánh con. Tiếp tục?')) {
                    setCayGiaPha(prev => xoaNutKhoiCay(prev, id));
                }
            };

            const xuLyZoom = (delta) => setTyLeZoom(prev => Math.max(0.2, Math.min(2.0, prev + delta)));
            const batDauKeo = () => setDangKeo(true);
            const ketThucKeo = () => setDangKeo(false);
            const dangDiChuyen = (e) => { if (dangKeo) setViTri(prev => ({ x: prev.x + e.movementX, y: prev.y + e.movementY })); };
            const xuLyIn = () => window.print();

            return (
                <div className="h-screen flex flex-col bg-gray-50 overflow-hidden font-sans text-slate-800">
                    <div className="bg-white shadow-sm border-b p-4 flex justify-between items-center z-40 print:hidden">
                        <div className="flex items-center space-x-3">
                            <div className="bg-blue-600 p-2 rounded-lg text-white"><Icons.Move size={24} /></div>
                            <h1 className="text-xl font-bold text-gray-800">Cây Gia Phả</h1>
                        </div>
                        <div className="flex items-center space-x-2 bg-gray-100 p-1 rounded-lg">
                            <button onClick={() => xuLyZoom(-0.1)} className="p-2 hover:bg-white rounded-md"><Icons.ZoomOut size={20} /></button>
                            <span className="text-xs font-mono w-12 text-center">{Math.round(tyLeZoom * 100)}%</span>
                            <button onClick={() => xuLyZoom(0.1)} className="p-2 hover:bg-white rounded-md"><Icons.ZoomIn size={20} /></button>
                        </div>
                        <div className="flex space-x-3">
                            <button onClick={() => { setCayGiaPha(duLieuKhoiTao); setViTri({x:0, y:0}); setTyLeZoom(1); }} className="flex items-center space-x-2 px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg"><Icons.Trash2 size={18} /><span>Mới</span></button>
                            <button onClick={xuLyIn} className="flex items-center space-x-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm"><Icons.Download size={18} /><span>In/Lưu</span></button>
                        </div>
                    </div>

                    <div className={`flex-1 overflow-hidden relative cursor-${dangKeo ? 'grabbing' : 'grab'} bg-slate-50`} onMouseDown={batDauKeo} onMouseUp={ketThucKeo} onMouseLeave={ketThucKeo} onMouseMove={dangDiChuyen}>
                        <div className="absolute inset-0 opacity-10 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#cbd5e1 1px, transparent 1px)', backgroundSize: '20px 20px' }}></div>
                        <div ref={vungVeRef} className="absolute origin-top-left transition-transform duration-75 ease-out min-w-max min-h-max p-20" style={{ transform: `translate(${viTri.x + window.innerWidth/2 - 100}px, ${viTri.y + 100}px) scale(${tyLeZoom})` }}>
                            <NutCay nut={cayGiaPha} onThem={moModalThem} onSua={moModalSua} onXoa={xuLyXoa} onDoiBoCuc={xuLyDoiBoCuc} capDo={0} />
                        </div>
                    </div>
                    <ModalNhapLieu dangMo={modal.mo} cheDo={modal.cheDo} duLieu={modal.duLieuCu} onClose={() => setModal({ ...modal, mo: false })} onSave={xuLyLuuModal} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<UngDungGiaPha />);
    </script>
</body>
</html>
